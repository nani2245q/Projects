<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitZone - Workouts</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">FitZone</div>
        <div class="nav-links">
            <a href="/">Dashboard</a>
            <a href="/pages/workouts.html" class="active">Workouts</a>
            <a href="/pages/exercises.html">Exercises</a>
            <a href="/pages/activity.html">Activity Log</a>
            <span id="user-name"></span>
            <a href="/pages/login.html" id="auth-link">Login</a>
        </div>
    </nav>

    <main class="container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
            <h1>My Workouts</h1>
            <button class="btn btn-primary" onclick="toggleForm()">+ New Workout</button>
        </div>

        <div id="workout-form" class="card" style="display:none;margin-bottom:1.5rem">
            <h2>Log a Workout</h2>
            <div class="form-group">
                <label>Workout Name</label>
                <input type="text" id="w-name" placeholder="e.g. Upper Body Day">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="w-notes" rows="2" placeholder="Optional notes"></textarea>
            </div>
            <h3 style="margin:.8rem 0 .5rem">Exercises</h3>
            <div id="exercise-rows"></div>
            <button class="btn btn-sm btn-accent" style="margin:.5rem 0" onclick="addExerciseRow()">+ Add Exercise</button>
            <br>
            <button class="btn btn-primary" onclick="submitWorkout()">Save Workout</button>
        </div>

        <div id="workouts-list"></div>
    </main>

    <script src="/js/config.js"></script>
    <script>
        let exercises = [];

        async function init() {
            if (!isLoggedIn()) { window.location.href = '/pages/login.html'; return; }
            exercises = await apiFetch('/api/exercises');
            loadWorkouts();
        }

        function toggleForm() {
            const form = document.getElementById('workout-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            if (form.style.display === 'block' && document.getElementById('exercise-rows').children.length === 0) addExerciseRow();
        }

        function addExerciseRow() {
            const container = document.getElementById('exercise-rows');
            const row = document.createElement('div');
            row.className = 'workout-exercise-row';
            row.innerHTML = `
                <select class="ex-select">
                    <option value="">Select exercise</option>
                    ${(exercises || []).map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                </select>
                <input type="number" class="ex-sets" placeholder="Sets" min="1" style="width:70px">
                <input type="number" class="ex-reps" placeholder="Reps" min="1" style="width:70px">
                <input type="number" class="ex-weight" placeholder="kg" min="0" step="0.5" style="width:70px">
                <input type="number" class="ex-duration" placeholder="sec" min="0" style="width:70px">
                <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(row);
        }

        async function submitWorkout() {
            const rows = document.querySelectorAll('.workout-exercise-row');
            const exerciseEntries = [];
            rows.forEach(row => {
                const id = row.querySelector('.ex-select').value;
                if (!id) return;
                exerciseEntries.push({
                    exerciseId: parseInt(id),
                    sets: parseInt(row.querySelector('.ex-sets').value) || 3,
                    reps: parseInt(row.querySelector('.ex-reps').value) || 10,
                    weightKg: parseFloat(row.querySelector('.ex-weight').value) || null,
                    durationSeconds: parseInt(row.querySelector('.ex-duration').value) || null
                });
            });

            const body = {
                name: document.getElementById('w-name').value || 'Workout',
                notes: document.getElementById('w-notes').value,
                exercises: exerciseEntries
            };

            await apiFetch('/api/workouts', { method: 'POST', body: JSON.stringify(body) });
            toggleForm();
            loadWorkouts();
        }

        async function loadWorkouts() {
            const workouts = await apiFetch('/api/workouts');
            const container = document.getElementById('workouts-list');
            container.innerHTML = '';

            (Array.isArray(workouts) ? workouts : []).forEach(w => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.marginBottom = '1rem';
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <h3>${w.name || 'Workout'}</h3>
                            <p class="meta">${w.exerciseCount || 0} exercises · ${w.durationMinutes ? w.durationMinutes + ' min' : 'In progress'} · ${w.caloriesBurned ? Math.round(w.caloriesBurned) + ' cal' : ''}</p>
                            <p class="meta">${new Date(w.createdAt).toLocaleDateString()}</p>
                        </div>
                        <div>
                            <span class="status-badge status-${w.status.toLowerCase()}">${w.status}</span>
                            ${w.status === 'IN_PROGRESS' ? `<button class="btn btn-accent btn-sm" style="margin-left:.5rem" onclick="completeWorkout(${w.id})">Complete</button>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (container.children.length === 0) container.innerHTML = '<p style="color:var(--text-light)">No workouts yet. Start your first one!</p>';
        }

        async function completeWorkout(id) {
            await apiFetch(`/api/workouts/${id}/complete`, { method: 'POST' });
            loadWorkouts();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
